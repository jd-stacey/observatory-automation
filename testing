# In SpectroscopyImagingSession.__init__(), replace this section:

class SpectroscopyImagingSession(ImagingSession):
    """Imaging session using only the guide camera for spectroscopy"""

    def __init__(self, camera_manager, corrector, config_loader, target_info: TargetInfo,
                 ignore_twilight: bool = False, exposure_override: Optional[float] = None,  # Changed back to None
                 dry_run: bool = False):
        
        self.dry_run = dry_run
        self.logger = logging.getLogger(__name__)
        
        # Load platesolve config first to get spectro settings
        platesolve_config = config_loader.get_config('platesolving')
        spectro_acq_cfg = platesolve_config.get('spectro_acquisition', {})
        
        # Calculate exposure based on priority: override -> YAML -> magnitude calculation
        if exposure_override is not None:
            # Explicit override provided
            final_exposure = exposure_override
            self.logger.debug(f"Using explicit exposure override: {final_exposure:.1f}s")
        else:
            # Try to get from YAML config first
            yaml_exposure = spectro_acq_cfg.get('exposure_time')
            if yaml_exposure is not None:
                final_exposure = yaml_exposure
                self.logger.debug(f"Using YAML spectro_acquisition.exposure_time: {final_exposure:.1f}s")
            elif hasattr(target_info, 'gaia_g_mag'):
                # Calculate from magnitude as fallback
                base_exp = 30.0
                mag_diff = target_info.gaia_g_mag - 12.0
                calculated_exp = base_exp * (2.5 ** mag_diff)  # 2.5x per magnitude
                final_exposure = max(1.0, min(calculated_exp, 300.0))  # Clamp 1-300s
                self.logger.debug(f"Calculated exposure from magnitude {target_info.gaia_g_mag}: {final_exposure:.1f}s")
            else:
                # Final fallback
                final_exposure = 10.0
                self.logger.debug(f"Using fallback exposure time: {final_exposure:.1f}s")
        
        # Store the final exposure time
        exposure_override = final_exposure
