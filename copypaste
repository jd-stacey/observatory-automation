class SpectroscopySession:
    """Manages spectroscopy sessions with optional mirror support and automatic shutdown"""

    def __init__(self, camera_manager, corrector, config_loader, telescope_driver,
                 mirror_file: str = None, ignore_twilight: bool = False,
                 dry_run: bool = False, exposure_override: Optional[float] = None,
                 duration_override: Optional[float] = None):
        self.camera_manager = camera_manager
        self.corrector = corrector
        self.config_loader = config_loader
        self.telescope_driver = telescope_driver
        self.ignore_twilight = ignore_twilight
        self.dry_run = dry_run
        self.exposure_override = exposure_override
        self.duration_override = duration_override

        self.mirror = TelescopeMirror(mirror_file) if mirror_file else None
        self.current_session = None
        self.current_target = None
        self.logger = logging.getLogger(__name__)
        
        # Initialize observability checker for target validation AND shutdown checks
        observatory_config = config_loader.get_config('observatory')
        self.obs_checker = ObservabilityChecker(observatory_config)
        
        # Add shutdown tracking
        self.should_shutdown = False
        self.shutdown_reason = None

    def check_should_shutdown(self) -> bool:
        """Check if we should shutdown due to sun rise or other conditions"""
        # If ignore_twilight is set, don't shutdown based on sun altitude
        if self.ignore_twilight:
            return False
            
        try:
            # Create a dummy target to check sun conditions - we just need sun altitude
            # Use current telescope position if available, otherwise use a reference point
            if self.current_target:
                ra_hours = self.current_target['ra_hours']
                dec_deg = self.current_target['dec_deg']
            else:
                # Use a reference point (doesn't matter for sun altitude check)
                ra_hours, dec_deg = 12.0, 0.0
            
            obs_status = self.obs_checker.check_target_observability(
                ra_hours, dec_deg, ignore_twilight=False
            )
            
            # Check if sun is too high (above twilight limit)
            observatory_config = self.config_loader.get_config('observatory')
            twilight_limit = observatory_config.get('twilight_altitude', -18.0)
            
            if obs_status.sun_altitude > twilight_limit:
                sun_condition = "daylight" if obs_status.sun_altitude > 0 else "twilight"
                self.shutdown_reason = f"Sun too high for observations: {obs_status.sun_altitude:.1f}° > {twilight_limit}° ({sun_condition})"
                self.should_shutdown = True
                return True
                
            return False
            
        except Exception as e:
            self.logger.warning(f"Error checking shutdown conditions: {e}")
            return False

    def start_monitoring(self, poll_interval: float = 10.0):
        self.logger.info("="*60)
        self.logger.info(" "*15+"STARTING SPECTROSCOPY MONITORING")
        self.logger.info("="*60)
        if self.mirror:
            self.logger.info(f"Monitoring mirror file: {self.mirror.mirror_file}")
        if self.dry_run:
            self.logger.info("DRY RUN MODE - No telescope movement")
        
        # Add shutdown monitoring info
        if self.ignore_twilight:
            self.logger.info("Automatic shutdown DISABLED due to --ignore-twilight flag")
        else:
            self.logger.info("Automatic shutdown enabled when sun rises")

        try:
            while True:
                # **NEW: Check for shutdown conditions first**
                if self.check_should_shutdown():
                    self.logger.info("="*60)
                    self.logger.info("SHUTDOWN CONDITION DETECTED")
                    self.logger.info(f"Reason: {self.shutdown_reason}")
                    self.logger.info("="*60)
                    break
                
                self.logger.debug(f"Polling for new targets... (poll interval: {poll_interval}s)")
                
                if self.mirror:
                    new_target = self.mirror.check_for_new_target()
                    if new_target:
                        self.logger.info("NEW TARGET DETECTED")
                        self.logger.info(f"RA={new_target['ra_hours']:.6f} h, Dec={new_target['dec_deg']:.6f}°")
                        
                        # Check observability before attempting to use target
                        if not self._validate_target_observability(new_target):
                            self.logger.warning("Target not observable, marking as failed")
                            self.mirror.mark_target_failed(new_target['target_key'])
                            continue
                        
                        # Properly stop current session before starting new one
                        if self.current_session and self.current_session.is_running():
                            self.logger.info("Stopping current session...")
                            try:
                                self.current_session.stop_session()
                                # Wait a moment for cleanup
                                time.sleep(2.0)
                            except Exception as e:
                                self.logger.warning(f"Error stopping session: {e}")
                            finally:
                                self.current_session = None
                                self.current_target = None
                        
                        # Try to start new session
                        if not self._start_new_session(new_target):
                            # Mark as failed to avoid retry loops
                            self.mirror.mark_target_failed(new_target['target_key'])
                    else:
                        self.logger.debug("No new targets found")
                
                # Clean up finished sessions
                if self.current_session and not self.current_session.is_running():
                    self.logger.info("Current session finished")
                    self.current_session = None
                    self.current_target = None
                            
                time.sleep(poll_interval)
                
        except KeyboardInterrupt:
            self.logger.info("Monitoring interrupted by user")
            self.shutdown_reason = "User interruption"
        except Exception as e:
            self.logger.error(f"Critical error in monitoring loop: {e}")
            self.shutdown_reason = f"Critical error: {e}"
        finally:
            # Enhanced cleanup with shutdown info
            self.logger.info("="*60)
            self.logger.info("BEGINNING SHUTDOWN SEQUENCE")
            if self.shutdown_reason:
                self.logger.info(f"Shutdown reason: {self.shutdown_reason}")
            self.logger.info("="*60)
            
            # Cleanup current session
            if self.current_session:
                try:
                    self.logger.info("Stopping active imaging session...")
                    self.current_session.stop_session()
                except Exception as e:
                    self.logger.warning(f"Error during session cleanup: {e}")
                finally:
                    self.current_session = None
            
            self.logger.info("Spectroscopy monitoring ended - hardware cleanup will follow")

    def _validate_target_observability(self, target_data: Dict[str, Any]) -> bool:
        """Check if target is observable before attempting to use it"""
        try:
            obs_status = self.obs_checker.check_target_observability(
                target_data['ra_hours'],
                target_data['dec_deg'],
                ignore_twilight=self.ignore_twilight
            )
            
            if obs_status.observable:
                self.logger.debug(f"Target is observable (alt={obs_status.target_altitude:.1f}°)")
                return True
            else:
                reasons = "; ".join(obs_status.reasons)
                self.logger.info(f"Target not observable: {reasons}")
                return False
                
        except Exception as e:
            self.logger.error(f"Error checking target observability: {e}")
            return False

    def _start_new_session(self, target_data: Dict[str, Any]) -> bool:
        """Start new session with proper error handling and safety checks"""
        try:
            timestamp_suffix = target_data['timestamp'].strftime('%H%M%S')
            target_info = TargetInfo(
                tic_id=f"MIRROR_{target_data['ra_hours']:.3f}h_{target_data['dec_deg']:+.3f}d_{timestamp_suffix}",
                ra_j2000_hours=target_data['ra_hours'],
                dec_j2000_deg=target_data['dec_deg'],
                gaia_g_mag=12.0,
                magnitude_source="spectro-default"
            )

            # Set target in corrector before starting session
            if self.corrector and hasattr(self.corrector, 'set_current_target'):
                self.corrector.set_current_target(target_info.tic_id, self.exposure_override)

            # Slew telescope (with safety checks)
            if not self.dry_run:
                self.logger.info("Slewing telescope to target...")
                if not self.telescope_driver or not self.telescope_driver.slew_to_coordinates(
                    target_info.ra_j2000_hours, target_info.dec_j2000_deg
                ):
                    self.logger.error("Failed to slew to target")
                    return False
            else:
                self.logger.info(f"DRY RUN: Would slew to RA={target_info.ra_j2000_hours:.6f}h, Dec={target_info.dec_j2000_deg:.6f}°")

            self.logger.info("Starting spectroscopy imaging session...")
            session = SpectroscopyImagingSession(
                camera_manager=self.camera_manager,
                corrector=self.corrector,
                config_loader=self.config_loader,
                target_info=target_info,
                ignore_twilight=self.ignore_twilight,
                dry_run=self.dry_run,
                exposure_override=self.exposure_override
            )

            # Start imaging asynchronously so monitoring can continue
            platesolve_config = self.config_loader.get_config("platesolving")
            spectro_config = platesolve_config.get("spectro_acquisition", {})
            default_duration = spectro_config.get("default_session_duration_hours", 1.0)
            duration_hours = self.duration_override or default_duration
            session.start_imaging_loop_async(duration_hours=duration_hours)

            self.current_session = session
            self.current_target = target_data
            self.logger.info("Session started successfully")
            return True
            
        except Exception as e:
            self.logger.error(f"Failed to start new session: {e}")
            return False
