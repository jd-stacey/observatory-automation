# In SpectroscopyCorrector.__init__
def __init__(self, telescope_driver, config_loader):
    # ... existing init code ...
    self.last_wait_failed_filename = None  # Track across wait calls

def wait_for_correction_with_timeout(self, timeout_seconds: float, current_frame_path: str = None) -> bool:
    """Wait for platesolve correction with active polling"""
    start_time = time.time()
    check_interval = 1.0
    
    logger.debug(f"Waiting up to {timeout_seconds:.1f}s for platesolve correction...")
    
    last_reason = None
    reason_count = 0
    
    def normalize_reason(reason: str) -> str:
        """Normalize reasons with varying numbers for deduplication"""
        import re
        reason = re.sub(r'\d+\.\d+s old', 'X.Xs old', reason)
        reason = re.sub(r'age: \d+ s', 'age: X s', reason)
        reason = re.sub(r'frame \d+', 'frame X', reason)
        return reason
    
    while (time.time() - start_time) < timeout_seconds:
        try:
            result = self.apply_immediate_correction_if_available(current_phase="spectro_sync", current_frame_path=current_frame_path)
            if result.applied:
                if reason_count > 1:
                    logger.debug(f"  (previous message repeated {reason_count} times)")
                logger.info(f"Correction applied during wait: {result.total_offset_arcsec:.2f}\" offset")
                time.sleep(result.settle_time)
                return True
            
            # No correction applied - keep waiting
            normalized = normalize_reason(result.reason)
            
            if normalized != last_reason:
                if reason_count > 1:
                    logger.debug(f"  (previous message repeated {reason_count} times)")
                logger.debug(result.reason)
                last_reason = normalized
                reason_count = 1
            else:
                reason_count += 1
                    
        except PlatesolveCorrectorError as e:
            # Failed platesolve detected - check if it's NEW
            file_ready, data = self.check_json_file_ready()
            current_failed_file = data.get('fitsname', {}).get("0", "") if file_ready else None
            
            if current_failed_file and current_failed_file != self.last_wait_failed_filename:
                # NEW failed solve - exit early
                self.last_wait_failed_filename = current_failed_file
                error_msg = str(e)
                normalized = normalize_reason(error_msg)
                
                if normalized != last_reason:
                    if reason_count > 1:
                        logger.debug(f"  (previous message repeated {reason_count} times)")
                    logger.debug(f"Platesolve failure detected: {error_msg}")
                
                logger.debug("New platesolve completed (failed) - ending wait early")
                return False
            else:
                # Same failed solve we've already seen, keep waiting
                normalized = normalize_reason(str(e))
                if normalized != last_reason:
                    if reason_count > 1:
                        logger.debug(f"  (previous message repeated {reason_count} times)")
                    logger.debug(f"Platesolve failure detected: {str(e)}")
                    last_reason = normalized
                    reason_count = 1
                else:
                    reason_count += 1
                    
        except Exception as e:
            logger.debug(f"Unexpected error during correction wait: {e}")
        
        time.sleep(check_interval)
    
    if reason_count > 1:
        logger.debug(f"  (previous message repeated {reason_count} times)")
    
    logger.warning(f"Platesolve timeout after {timeout_seconds:.1f} s - continuing")
    return False
